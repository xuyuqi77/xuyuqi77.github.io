<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="xuyuqi,xuyuqi16@gmail.com"><title>tomcat-jdbc-pool源码 · 徐煜企的博客</title><meta name="description" content="Tomcat-jdbc-pool源码分析连接池初始化
初始化步骤： {@method init}
1.参数检查  {@method checkPoolConfiguration}
2.创建busy队列与idle队列 （idle队列区分公平与非公平，fair ?  FairBlockingQueue "><meta name="keywords" content="Java, Mysql, Wechat"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">徐煜企的博客</a></h3><div class="description"><p>聪明机智又可爱</p></div></div></div><ul class="social-links"><li><a href="http://github.com/xuyuqi77"><i class="fa fa-github"></i></a></li></ul></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>tomcat-jdbc-pool源码</a></h3></div><div class="post-content"><h1 id="Tomcat-jdbc-pool源码分析"><a href="#Tomcat-jdbc-pool源码分析" class="headerlink" title="Tomcat-jdbc-pool源码分析"></a>Tomcat-jdbc-pool源码分析</h1><h2 id="连接池初始化"><a href="#连接池初始化" class="headerlink" title="连接池初始化"></a>连接池初始化</h2><blockquote>
<p>初始化步骤： {@method init}</p>
<p>1.参数检查  {@method checkPoolConfiguration}</p>
<p>2.创建busy队列与idle队列 （idle队列区分公平与非公平，fair ?  FairBlockingQueue : LinkedBlockingQueue 另外FairBlockingQueue里是items和waiters两个LinkedList）</p>
<p>3.初始化连接池清理任务  {@method initializePoolCleaner}（定时任务,间隔配置{@properties TimeBetweenEvictionRunsMillis}）</p>
<p>4.JMX钩子方法</p>
<p>5.解析并创建初始JDBC拦截器</p>
<p>6.预热连接池,即往busy队列添加{@properties InitialSize}个连接 {@method borrowConnection}</p>
<p>7.回收预热的连接,即将busy队列中{@properties InitialSize}个连接释放回idle队列  {@method returnConnection}</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(PoolConfiguration properties)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  	<span class="comment">// 1.参数检查</span></span><br><span class="line">  	checkPoolConfiguration(properties);</span><br><span class="line">  	<span class="comment">// 2.创建busy队列与idle队列</span></span><br><span class="line">  	busy = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">  	<span class="keyword">if</span> (properties.isFairQueue()) &#123;</span><br><span class="line">  		idle = <span class="keyword">new</span> FairBlockingQueue&lt;&gt;();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      idle = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 3.初始化清理任务</span></span><br><span class="line">  	initializePoolCleaner(properties);</span><br><span class="line">  	<span class="comment">// 4.JMX钩子方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getPoolProperties().isJmxEnabled()) createMBean();</span><br><span class="line">		<span class="comment">// 5.解析并创建初始JDBC拦截器</span></span><br><span class="line">  	<span class="comment">// 加载配置中的拦截器</span></span><br><span class="line">    PoolProperties.InterceptorDefinition[] proxies = getPoolProperties().getJdbcInterceptorsAsArray();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;proxies.length; i++) &#123;</span><br><span class="line">      	<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 实例化拦截器</span></span><br><span class="line">          JdbcInterceptor interceptor = proxies[i].getInterceptorClass().newInstance();</span><br><span class="line">          interceptor.setProperties(proxies[i].getProperties());</span><br><span class="line">          interceptor.poolStarted(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.预热连接池 </span></span><br><span class="line">    PooledConnection[] initialPool = <span class="keyword">new</span> PooledConnection[poolProperties.getInitialSize()];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; initialPool.length; i++) &#123;</span><br><span class="line">          	<span class="comment">// 从连接池中获取连接，因为idle队列为空所以会创建initialSize个连接放入busy队列</span></span><br><span class="line">          	initialPool[i] = <span class="keyword">this</span>.borrowConnection(<span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException x) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; initialPool.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (initialPool[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                      	<span class="comment">// 将busy队列中的连接释放会idle队列</span></span><br><span class="line">                      	<span class="keyword">this</span>.returnConnection(initialPool[i]);</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Exception x)&#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		closed = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="从连接池获取连接"><a href="#从连接池获取连接" class="headerlink" title="从连接池获取连接"></a>从连接池获取连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 线程安全的方式从连接池获取连接</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PooledConnection <span class="title">borrowConnection</span><span class="params">(<span class="keyword">int</span> wait, String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  	<span class="comment">// 1.判断连接池是否关闭</span></span><br><span class="line">    <span class="comment">// 2.从idle队列中获取连接</span></span><br><span class="line">    PooledConnection con = idle.poll();</span><br><span class="line">		<span class="comment">// 3.自旋</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    		<span class="keyword">if</span> (con!=<span class="keyword">null</span>) &#123;</span><br><span class="line">        		<span class="comment">// 3.1 配置并返回该连接，包括释放原连接，连接验证等，详见下方:验证并配置空闲的连接</span></span><br><span class="line">            PooledConnection result = borrowConnection(now, con, username, password);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// 3.2 获取的连接为空,需要创建新的连接并放入busy队列</span></span><br><span class="line">      	<span class="comment">//     判断连接池的总连接数是否 &lt; 配置的最大活跃连接数</span></span><br><span class="line">        <span class="keyword">if</span> (size.get() &lt; getPoolProperties().getMaxActive()) &#123;</span><br><span class="line">           <span class="keyword">if</span> (size.addAndGet(<span class="number">1</span>) &gt; getPoolProperties().getMaxActive()) &#123;</span><br><span class="line">              <span class="comment">// 3.2.1 存在竞争,且当前线程竞争失败</span></span><br><span class="line">           		size.decrementAndGet();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           		<span class="comment">// 3.2.1 创建新连接</span></span><br><span class="line">              <span class="keyword">return</span> createConnection(now, con, username, password);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      	</span><br><span class="line">      	<span class="comment">// 当连接池中总连接数已达到最大活跃数时，新来的请求就需要等待</span></span><br><span class="line">				<span class="comment">// 3.3 获取等待时间与最大等待时间</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	<span class="comment">// 3.4 尝试带有等待时间的从idle队列中获取连接</span></span><br><span class="line">        		con = idle.poll(timetowait, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// 3.5 未获取到连接</span></span><br><span class="line">        <span class="keyword">if</span> (con == <span class="keyword">null</span>) &#123;</span><br><span class="line">        		<span class="comment">// 判断是否超过了最大等待时间</span></span><br><span class="line">            <span class="keyword">if</span> ((System.currentTimeMillis() - now) &gt;= maxWait) &#123;</span><br><span class="line">            		<span class="comment">// ignore     </span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 未超过则重新尝试</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="验证并配置空闲的连接"><a href="#验证并配置空闲的连接" class="headerlink" title="验证并配置空闲的连接"></a>验证并配置空闲的连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> PooledConnection <span class="title">borrowConnection</span><span class="params">(<span class="keyword">long</span> now, PooledConnection con, String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// 1.连接加锁</span></span><br><span class="line">        con.lock();</span><br><span class="line">      	<span class="comment">// 2.判断连接是否被释放</span></span><br><span class="line">        <span class="keyword">if</span> (con.isReleased()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.账号密码变更或连接达到最大连接时间，则要求强制重连</span></span><br><span class="line">        <span class="keyword">boolean</span> forceReconnect = con.shouldForceReconnect(username, password) || con.isMaxAgeExpired();</span><br><span class="line">			  <span class="comment">// 4.该连接失效，但没有被丢弃，则要求强制重连</span></span><br><span class="line">        <span class="keyword">if</span> (!con.isDiscarded() &amp;&amp; !con.isInitialized()) &#123;</span><br><span class="line">            forceReconnect = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!forceReconnect) &#123;</span><br><span class="line">          	<span class="comment">// 连接有效且通过连接检测</span></span><br><span class="line">            <span class="keyword">if</span> ((!con.isDiscarded()) &amp;&amp; con.validate(PooledConnection.VALIDATE_BORROW)) &#123;</span><br><span class="line">                <span class="comment">// 向busy队列放入该连接</span></span><br><span class="line">                busy.offer(con));</span><br><span class="line">                <span class="keyword">return</span> con;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// 到这一步，说明这个连接要么还被其他人拥有，或已经失效，或连接检验失败</span></span><br><span class="line">      	<span class="comment">// 这里会再尝试连接一次，为了不让这个连接再次被轮训到。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重连</span></span><br><span class="line">            con.reconnect();</span><br><span class="line">            <span class="comment">// 连接校验</span></span><br><span class="line">            <span class="keyword">if</span> (con.validate(validationMode)) &#123;</span><br><span class="line">              	<span class="comment">// 向busy队列放入该连接</span></span><br><span class="line">                busy.offer(con))</span><br><span class="line">                <span class="keyword">return</span> con;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            <span class="comment">// 释放连接</span></span><br><span class="line">            release(con);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      	<span class="comment">// 释放锁</span></span><br><span class="line">        con.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PooledConnection <span class="title">createConnection</span><span class="params">(<span class="keyword">long</span> now, PooledConnection notUsed, String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个连接对象</span></span><br><span class="line">    PooledConnection con = create(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 加锁</span></span><br><span class="line">        con.lock();</span><br><span class="line">      	<span class="comment">// 尝试连接数据库</span></span><br><span class="line">        con.connect();</span><br><span class="line">        <span class="keyword">if</span> (con.validate(PooledConnection.VALIDATE_INIT)) &#123;</span><br><span class="line">					  <span class="comment">// 通过检验，则将连接放到busy队列</span></span><br><span class="line">            busy.offer(con))</span><br><span class="line">            <span class="keyword">return</span> con;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error ) &#123;</span><br><span class="line">          	<span class="comment">// 发生错误就释放该连接</span></span><br><span class="line">            release(con);</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// 释放锁</span></span><br><span class="line">        con.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="向连接池返回连接"><a href="#向连接池返回连接" class="headerlink" title="向连接池返回连接"></a>向连接池返回连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个连接放回连接池</span></span><br><span class="line"><span class="comment"> * 如果连接池已经关闭，则释放这个连接</span></span><br><span class="line"><span class="comment"> * 如果这个连接不属于busy队列，则释放这个连接</span></span><br><span class="line"><span class="comment"> * 如果配置了&#123;<span class="doctag">@link</span> PoolProperties#testOnReturn&#125;为true,在放回连接池前会检验连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">returnConnection</span><span class="params">(PooledConnection con)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.判断连接池是否关闭</span></span><br><span class="line">    <span class="keyword">if</span> (isClosed()) &#123;</span><br><span class="line">        <span class="comment">// 1.1 释放连接</span></span><br><span class="line">        release(con);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.计数</span></span><br><span class="line">            returnedCount.incrementAndGet();</span><br><span class="line">            <span class="comment">// 3.加锁</span></span><br><span class="line">            con.lock();</span><br><span class="line">            <span class="keyword">if</span> (con.isSuspect()) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 4.将连接从busy队列移除</span></span><br><span class="line">            <span class="keyword">if</span> (busy.remove(con)) &#123;</span><br><span class="line">                <span class="comment">// 4.1 判断返回连接池时，是否需要关闭连接</span></span><br><span class="line">                <span class="keyword">if</span> (!shouldClose(con,PooledConnection.VALIDATE_RETURN)) &#123;</span><br><span class="line">                    <span class="comment">// 满足以下任意条件</span></span><br><span class="line">                    <span class="comment">// a.idle队列数量超过最大值 &amp;&amp; 连接池关闭了清理者</span></span><br><span class="line">                    <span class="comment">// b.往idle里放入连接失败</span></span><br><span class="line">                    <span class="keyword">if</span> (((idle.size()&gt;=poolProperties.getMaxIdle()) &amp;&amp; !poolProperties.isPoolSweeperEnabled()) || (!idle.offer(con))) &#123;</span><br><span class="line">                        <span class="comment">// 释放连接</span></span><br><span class="line">                        release(con);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 返回连接池时，需要关闭连接</span></span><br><span class="line">                    release(con);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 连接从busy队列移除失败，释放连接</span></span><br><span class="line">                release(con);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            con.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="release方法"><a href="#release方法" class="headerlink" title="release方法"></a>release方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程安全的方式释放连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(PooledConnection con)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (con == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        con.lock();</span><br><span class="line">        <span class="keyword">if</span> (con.release()) &#123;</span><br><span class="line">            <span class="comment">// 连接总数减一</span></span><br><span class="line">            size.addAndGet(-<span class="number">1</span>);</span><br><span class="line">            con.setHandler(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        releasedCount.incrementAndGet();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        con.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 异步减少了连接数</span></span><br><span class="line">    <span class="comment">// 可能有线程永远在等待获取连接,所以需要有下满的处理</span></span><br><span class="line">    <span class="keyword">if</span> (waitcount.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        idle.offer(create(<span class="keyword">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method is called if (Now - timeCheckedIn &amp;gt; getReleaseTime())</span></span><br><span class="line"><span class="comment"> * This method disconnects the connection, logs an error in debug mode if it happens</span></span><br><span class="line"><span class="comment"> * then sets the &#123;<span class="doctag">@link</span> #released&#125; flag to false. Any attempts to connect this cached object again</span></span><br><span class="line"><span class="comment"> * will fail per &#123;<span class="doctag">@link</span> #connect()&#125;</span></span><br><span class="line"><span class="comment"> * The connection pool uses the atomic return value to decrement the pool size counter.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if this is the first time this method has been called. false if this method has been called before.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        disconnect(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> released.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="disconnect方法"><a href="#disconnect方法" class="headerlink" title="disconnect方法"></a>disconnect方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Disconnects the connection. All exceptions are logged using debug level.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> finalize if set to true, a call to &#123;<span class="doctag">@link</span> ConnectionPool#finalize(PooledConnection)&#125; is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(<span class="keyword">boolean</span> finalize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isDiscarded() &amp;&amp; connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.连接设置为失效</span></span><br><span class="line">    setDiscarded(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2.通知拦截器连接释放</span></span><br><span class="line">            parent.disconnectEvent(<span class="keyword">this</span>, finalize);</span><br><span class="line">            <span class="comment">// 3.关闭连接</span></span><br><span class="line">            <span class="keyword">if</span> (xaConnection == <span class="keyword">null</span>) &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                xaConnection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    connection = <span class="keyword">null</span>;</span><br><span class="line">    xaConnection = <span class="keyword">null</span>;</span><br><span class="line">    lastConnected = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 4.调用拦截器reset方法,但是参数都为null</span></span><br><span class="line">    <span class="keyword">if</span> (finalize) parent.finalize(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="清理任务"><a href="#清理任务" class="headerlink" title="清理任务"></a>清理任务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接清理任务是一个定时任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolCleaner</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> WeakReference&lt;ConnectionPool&gt; pool;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> sleepTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    PoolCleaner(ConnectionPool pool, <span class="keyword">long</span> sleepTime) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pool = <span class="keyword">new</span> WeakReference&lt;&gt;(pool);</span><br><span class="line">        <span class="keyword">this</span>.sleepTime = sleepTime;</span><br><span class="line">        <span class="keyword">if</span> (sleepTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果间隔时间小于0，则默认为30秒</span></span><br><span class="line">            <span class="keyword">this</span>.sleepTime = <span class="number">1000</span> * <span class="number">30</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectionPool pool = <span class="keyword">this</span>.pool.get();</span><br><span class="line">        <span class="keyword">if</span> (pool == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 连接为空，则停止该定时任务</span></span><br><span class="line">            stopRunning();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pool.isClosed()) &#123;</span><br><span class="line">            <span class="comment">// 连接未关闭</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// a.启用连接时间超出了removeAbandonedTimeout，清除废弃连接。</span></span><br><span class="line">                <span class="comment">// b.设置了连接超时时间(timeout &gt; 0)</span></span><br><span class="line">                <span class="keyword">if</span> (pool.getPoolProperties().isRemoveAbandoned()</span><br><span class="line">                        || pool.getPoolProperties().getSuspectTimeout() &gt; <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">// 检查连接池中所有连接是否超时</span></span><br><span class="line">                    pool.checkAbandoned();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// idle队列连接数量 &gt; idle最小值 </span></span><br><span class="line">                <span class="keyword">if</span> (pool.getPoolProperties().getMinIdle() &lt; pool.idle.size())</span><br><span class="line">                    <span class="comment">// 检查idle队列,调整idle连接数</span></span><br><span class="line">                    pool.checkIdle();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 是否启用验证连接是否可用，进行清理</span></span><br><span class="line">                <span class="keyword">if</span> (pool.getPoolProperties().isTestWhileIdle())</span><br><span class="line">                    <span class="comment">// 检查连接是否可用，否则清理</span></span><br><span class="line">                    pool.testAllIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="checkAbandoned方法"><a href="#checkAbandoned方法" class="headerlink" title="checkAbandoned方法"></a>checkAbandoned方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAbandoned</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (busy.size()==<span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        Iterator&lt;PooledConnection&gt; locked = busy.iterator();</span><br><span class="line">        <span class="keyword">int</span> sto = getPoolProperties().getSuspectTimeout();</span><br><span class="line">        <span class="keyword">while</span> (locked.hasNext()) &#123;</span><br><span class="line">            PooledConnection con = locked.next();</span><br><span class="line">            <span class="keyword">boolean</span> setToNull = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                con.lock();</span><br><span class="line">                <span class="comment">// 如果连接已经放回idle队列，或者已经被释放，则跳过</span></span><br><span class="line">                <span class="keyword">if</span> (idle.contains(con) || con.isReleased())</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">long</span> time = con.getTimestamp();</span><br><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// a.(busy队列连接数 / 最大值) &gt;= abandonWhenPercentageFull 即超过某个百分比</span></span><br><span class="line">                <span class="comment">// b.已连接时间 &gt; abandonTimeOut </span></span><br><span class="line">                <span class="keyword">if</span> (shouldAbandon() &amp;&amp; (now - time) &gt; con.getAbandonTimeout()) &#123;</span><br><span class="line">                    busy.remove(con);</span><br><span class="line">                    <span class="comment">// 线程安全的抛弃连接 (注:抛弃连接 != 释放连接release，多一些逻辑)</span></span><br><span class="line">                    abandon(con);</span><br><span class="line">                    setToNull = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sto &gt; <span class="number">0</span> &amp;&amp; (now - time) &gt; (sto * <span class="number">1000L</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 连接时间 &gt; suspectTimeout, 设置为可疑连接</span></span><br><span class="line">                    suspect(con);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                con.unlock();</span><br><span class="line">                <span class="keyword">if</span> (setToNull)</span><br><span class="line">                    con = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConcurrentModificationException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="checkIdle方法"><a href="#checkIdle方法" class="headerlink" title="checkIdle方法"></a>checkIdle方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkIdle</span><span class="params">(<span class="keyword">boolean</span> ignoreMinSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (idle.size()==<span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        Iterator&lt;PooledConnection&gt; unlocked = idle.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// a. ignoreMinSize || idle连接数 &gt;= 最小值</span></span><br><span class="line">        <span class="comment">// b. 迭代器hasNext</span></span><br><span class="line">        <span class="keyword">while</span> ((ignoreMinSize || (idle.size()&gt;=getPoolProperties().getMinIdle())) &amp;&amp; unlocked.hasNext()) &#123;</span><br><span class="line">            PooledConnection con = unlocked.next();</span><br><span class="line">            <span class="keyword">boolean</span> setToNull = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                con.lock();</span><br><span class="line">                <span class="comment">// 若连接被放到busy队列，跳过</span></span><br><span class="line">                <span class="keyword">if</span> (busy.contains(con))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">long</span> time = con.getTimestamp();</span><br><span class="line">                <span class="comment">// 判断连接是否需要释放，条件如下</span></span><br><span class="line">                <span class="comment">// a.连接池版本 &lt; 最新版本</span></span><br><span class="line">                <span class="comment">// b.minEvictableIdleTimeMillis &gt; 0 &amp;&amp; 该连接空闲时间超过minEvictableIdleTimeMillis &amp;&amp; idle连接数大于最小值</span></span><br><span class="line">                <span class="keyword">if</span> (shouldReleaseIdle(now, con, time)) &#123;</span><br><span class="line">                    releasedIdleCount.incrementAndGet();</span><br><span class="line">                    release(con);</span><br><span class="line">                    idle.remove(con);</span><br><span class="line">                    setToNull = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                con.unlock();</span><br><span class="line">                <span class="keyword">if</span> (setToNull)</span><br><span class="line">                    con = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConcurrentModificationException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="testAllIdle方法"><a href="#testAllIdle方法" class="headerlink" title="testAllIdle方法"></a>testAllIdle方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAllIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (idle.size()==<span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        Iterator&lt;PooledConnection&gt; unlocked = idle.iterator();</span><br><span class="line">        <span class="keyword">while</span> (unlocked.hasNext()) &#123;</span><br><span class="line">            PooledConnection con = unlocked.next();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                con.lock();</span><br><span class="line">                <span class="comment">// 若连接被放到busy队列，跳过</span></span><br><span class="line">                <span class="keyword">if</span> (busy.contains(con))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// 连接检验不通过</span></span><br><span class="line">                <span class="keyword">if</span> (!con.validate(PooledConnection.VALIDATE_IDLE)) &#123;</span><br><span class="line">                    idle.remove(con);</span><br><span class="line">                    release(con);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                con.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConcurrentModificationException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-04-15</span><i class="fa fa-tag"></i><a class="tag" href="/tags/java/" title="java">java </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://xuyuqi77.github.io/2019/04/15/tomcat-jdbc-pool源码/,徐煜企的博客,tomcat-jdbc-pool源码,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/01/30/jvm内存划分/" title="jvm内存划分">Próximo post</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'ACHHxtdr6iGJakMn0fm8SfAO-gzGzoHsz',
  app_key:'O2Wqtq6XI9kCFU3UtjgwLRuW',
  placeholder:'请在此输入您的留言',
  path: window.location.pathname,
  avatar:'mm'
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>